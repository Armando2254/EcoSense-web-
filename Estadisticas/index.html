<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadisticas</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    
    <div class="container">
    <nav class="navbar">
    <p class="eco">Dashboard</p>
    <ul class="opciones">
        <li class="opcion"><a href="../Contenedores/index.html">Contenedores</a></li>
        <li class="opcion"><a href="../Estadisticas/index.html">Estadísticas</a></li>
        <li class="opcion"><a href="../Recolectores/index.html">Recolectores</a></li>
        <li class="opcion"><a href="../rutas/index.html">Rutas</a></li>
        <li class="opcion"><a href="../Perfil/index.html">Perfil</a></li>
        <img class="picture-user" src="../assets/images/PicUser.png" alt="UserPicture">
    </ul>
    </nav>




<main class="main">

<div id="tarjeta-tiempo-vaciado" style="margin-bottom:1rem; max-width:220px;">
  <div class="card-small" aria-live="polite" aria-label="Promedio de tiempo de vaciado">
    <div style="display:flex; justify-content: space-between; align-items: center; gap:0.5rem;">
      <div>
        <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:2px;">Tiempo de vaciado</div>
        <div id="tiempo-text" style="font-weight:700; font-size:1.4rem; line-height:1;">--:--:--</div>
      </div>
      <div id="badge-pequeno">Cargando</div>
    </div>
    <div id="subtexto" style="font-size:0.55rem; margin-top:4px; opacity:0.85;">Última actualización: --</div>
  </div>
</div>



  <div class="charts-grid">
    <!-- 1 -->
    <section class="chart-card">
      <h2>Porcentaje promedio por hora (por contenedor)</h2>
      <div class="controls">
        <select id="contenedorSelect"></select>
        <input type="date" id="fechaContenedor" />
        <button onclick=cargarGraficaContenedor()>Cargar</button>
      </div>
      <canvas id="graficaContenedor"></canvas>
    </section>

    <!-- 2 -->
    <section class="chart-card">
      <h2>Porcentaje promedio general por hora</h2>
      <div class="controls">
        <input type="date" id="fechaGeneral" />
        <button onclick=cargarGraficaGeneral()>Cargar</button>
      </div>
      <canvas id="graficaGeneral"></canvas>
    </section>

    <!-- 3 -->
    <section class="chart-card">
      <h2>Llenados por semana (general)</h2>
      <div class="controls">
        <input type="date" id="fechaSemana" />
        <button onclick="cargarGraficaSemana()">Cargar</button>
      </div>
      <canvas id="graficaSemana"></canvas>
    </section>

    <!-- 4 -->
    <section class="chart-card">
      <h2>Llenados por semana (por contenedor)</h2>
      <div class="controls">
        <select id="contenedorSemanaSelect"></select>
        <input type="date" id="fechaSemanaContenedor" />
        <button onclick="cargarGraficaSemanaContenedor()">Cargar</button>
      </div>
      <canvas id="graficaSemanaContenedor"></canvas>
    </section>

    <!-- 5 -->
    <section class="chart-card full-width">
      <h2>Registros por ubicación (por fecha)</h2>
      <div class="controls">
        <input type="date" id="fechaUbicacion" />
        <button onclick="cargarGraficaUbicacion()">Cargar</button>
      </div>
      <canvas id="graficaUbicacion"></canvas>
    </section>
  </div>
</main>









    <footer class="footer">
    <!-- Bloque Izquierdo: Título + Redes -->
    <div class="footer-left">
        <div class="social-icons">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
    </div>

    <!-- Bloque Derecho: Columnas -->
    <div class="footer-right">
        <div class="footer-columns">
        <div class="column">
            <h4>Proyecto</h4>
            <p>Visión</p>
            <p>Misión</p>
            <p>Objetivos</p>
        </div>
        <div class="column">
            <h4>Soporte</h4>
            <p>FAQ</p>
            <p>Contacto</p>
            <p>Ayuda</p>
        </div>
        <div class="column">
            <h4>Legal</h4>
            <p>Términos</p>
            <p>Privacidad</p>
            <p>Licencias</p>
        </div>
        </div>
    </div>
    </footer>


    </div>




<!-- Modal -->
<div id="modalContenedor" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; 
  background: rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%;">
    <h2 id="modalNombre"></h2>
    <p><strong>Porcentaje:</strong> <span id="modalPorcentaje"></span>%</p>
    <p><strong>Ubicación:</strong> <span id="modalUbicacion"></span></p>
    <p><strong>Latitud:</strong> <span id="modalLatitud"></span></p>
    <p><strong>Longitud:</strong> <span id="modalLongitud"></span></p>
    <div style="margin-top:20px; display:flex; justify-content:space-between;">
      <button id="btnCerrarModal" style="padding:10px 20px;">Cerrar</button>
    </div>
  </div>
</div>



<script src="/config/config.js"></script>

<script>
  let graficaContenedorInstance = null;
  let graficaGeneralInstance = null;
  let graficaSemanaInstance = null;
  let graficaSemanaContenedorInstance = null;
  let graficaUbicacionInstance = null;

  function formatDateInput(d) {
    return d.toISOString().slice(0, 10);
  }

  async function cargarContenedores() {
    try {
      const res = await fetch(window.settings.apiUrl+"Contenedor");
      const contenedores = await res.json();
      const selects = [
        document.getElementById("contenedorSelect"),
        document.getElementById("contenedorSemanaSelect"),
      ];
      for (const select of selects) {
        select.innerHTML = "";
        contenedores.forEach((c) => {
          const option = document.createElement("option");
          option.value = c.id;
          option.textContent = c.nombre || c.id;
          select.appendChild(option);
        });
      }

      // Set default dates
      const today = new Date();
      const isoToday = formatDateInput(today);
      document.getElementById("fechaContenedor").value = isoToday;
      document.getElementById("fechaGeneral").value = isoToday;
      document.getElementById("fechaUbicacion").value = isoToday;

      const semanaInicio = new Date();
      semanaInicio.setDate(today.getDate() - 7); // semana que termina hoy
      const isoSemanaInicio = formatDateInput(semanaInicio);
      document.getElementById("fechaSemana").value = isoSemanaInicio;
      document.getElementById("fechaSemanaContenedor").value = isoSemanaInicio;

      // Cargar gráficas iniciales con los valores por defecto
      await Promise.all([
        cargarGraficaContenedor(),
        cargarGraficaGeneral(),
        cargarGraficaSemana(),
        cargarGraficaSemanaContenedor(),
        cargarGraficaUbicacion(),
      ]);
    } catch (e) {
      console.error("Error al cargar contenedores o gráficas iniciales:", e);
    }
  }

  async function cargarGraficaContenedor() {
    const id = document.getElementById("contenedorSelect").value;
    const fecha = document.getElementById("fechaContenedor").value;
    if (!id || !fecha) return;

    const inicio = new Date(fecha);
    const fin = new Date(inicio);
    fin.setDate(fin.getDate() + 1);

    try {
      const res = await fetch(
        window.settings.apiUrl+`estadisticaslectura/promedio-por-hora?idContenedor=${id}&fechaInicio=${inicio.toISOString()}&fechaFin=${fin.toISOString()}`
      );
      const datos = await res.json();

      const horas = datos.map((d) => d.hora);
      const valores = datos.map((d) => d.promedioPorcentaje);

      if (graficaContenedorInstance) graficaContenedorInstance.destroy();
      graficaContenedorInstance = new Chart(
        document.getElementById("graficaContenedor"),
        {
          type: "line",
          data: {
            labels: horas,
            datasets: [
              {
                label: "Promedio %",
                data: valores,
                borderColor: "#4a6fa5",
                backgroundColor: "rgba(74, 111, 165, 0.1)",
                fill: true,
                tension: 0.3,
                pointRadius: 3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              x: { title: { display: true, text: "Hora" } },
              y: { title: { display: true, text: "Promedio %" }, beginAtZero: true },
            },
          },
        }
      );
    } catch (e) {
      console.error("Error en gráfica contenedor:", e);
    }
  }

  async function cargarGraficaGeneral() {
    const fecha = document.getElementById("fechaGeneral").value;
    if (!fecha) return;
    const inicio = new Date(fecha);
    const fin = new Date(inicio);
    fin.setDate(fin.getDate() + 1);

    try {
      const res = await fetch(
        window.settings.apiUrl+`estadisticaslectura/promedio-general-por-hora?fechaInicio=${inicio.toISOString()}&fechaFin=${fin.toISOString()}`
      );
      const datos = await res.json();

      const horas = datos.map((d) => d.numeroDeHora);
      const valores = datos.map((d) => d.promedioPorcentaje);

      if (graficaGeneralInstance) graficaGeneralInstance.destroy();
      graficaGeneralInstance = new Chart(
        document.getElementById("graficaGeneral"),
        {
          type: "bar",
          data: {
            labels: horas,
            datasets: [
              {
                label: "Promedio General %",
                data: valores,
                backgroundColor: "rgba(74, 111, 165, 0.6)",
                borderRadius: 4,
                barPercentage: 0.7,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              x: { title: { display: true, text: "Hora" } },
              y: { title: { display: true, text: "Promedio %" }, beginAtZero: true },
            },
          },
        }
      );
    } catch (e) {
      console.error("Error en gráfica general:", e);
    }
  }

  async function cargarGraficaSemana() {
    const fecha = document.getElementById("fechaSemana").value;
    if (!fecha) return;
    const inicio = new Date(fecha);
    const fin = new Date(inicio);
    fin.setDate(fin.getDate() + 7);

    try {
      const res = await fetch(
        window.settings.apiUrl+`estadisticasregistro/llenados-semana-general?inicio=${inicio.toISOString()}&fin=${fin.toISOString()}`
      );
      const datos = await res.json();

      const dias = datos.map((d) => d.dia);
      const valores = datos.map((d) => d.totalLlenados);

      if (graficaSemanaInstance) graficaSemanaInstance.destroy();
      graficaSemanaInstance = new Chart(
        document.getElementById("graficaSemana"),
        {
          type: "bar",
          data: {
            labels: dias,
            datasets: [
              {
                label: "Total Llenados",
                data: valores,
                backgroundColor: "rgba(100, 100, 100, 0.6)",
                borderRadius: 4,
                barPercentage: 0.7,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              x: { title: { display: true, text: "Día" } },
              y: { title: { display: true, text: "Llenados" }, beginAtZero: true },
            },
          },
        }
      );
    } catch (e) {
      console.error("Error en gráfica semana general:", e);
    }
  }

  async function cargarGraficaSemanaContenedor() {
    const id = document.getElementById("contenedorSemanaSelect").value;
    const fecha = document.getElementById("fechaSemanaContenedor").value;
    if (!id || !fecha) return;

    const inicio = new Date(fecha);
    const fin = new Date(inicio);
    fin.setDate(fin.getDate() + 7);

    try {
      const res = await fetch(
        window.settings.apiUrl+`estadisticasregistro/llenados-semana-contenedor?idContenedor=${id}&inicio=${inicio.toISOString()}&fin=${fin.toISOString()}`
      );
      const datos = await res.json();

      const dias = datos.map((d) => d.dia);
      const valores = datos.map((d) => d.totalLlenados);

      if (graficaSemanaContenedorInstance)
        graficaSemanaContenedorInstance.destroy();
      graficaSemanaContenedorInstance = new Chart(
        document.getElementById("graficaSemanaContenedor"),
        {
          type: "bar",
          data: {
            labels: dias,
            datasets: [
              {
                label: "Llenados por Contenedor",
                data: valores,
                backgroundColor: "rgba(74, 111, 165, 0.4)",
                borderRadius: 4,
                barPercentage: 0.7,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              x: { title: { display: true, text: "Día" } },
              y: { title: { display: true, text: "Llenados" }, beginAtZero: true },
            },
          },
        }
      );
    } catch (e) {
      console.error("Error en gráfica semana contenedor:", e);
    }
  }

  async function cargarGraficaUbicacion() {
    const fecha = document.getElementById("fechaUbicacion").value;
    if (!fecha) return;
    const inicio = new Date(fecha);
    const fin = new Date(inicio);
    fin.setDate(fin.getDate() + 1);

    try {
      const res = await fetch(
        window.settings.apiUrl+`estadisticasregistro/ubicaciones-por-fecha?inicio=${inicio.toISOString()}&fin=${fin.toISOString()}`
      );
      const datos = await res.json();

      const ubicaciones = datos.map((d) => d.ubicacion);
      const valores = datos.map((d) => d.total);

      if (graficaUbicacionInstance) graficaUbicacionInstance.destroy();
      graficaUbicacionInstance = new Chart(
        document.getElementById("graficaUbicacion"),
        {
          type: "bar",
          data: {
            labels: ubicaciones,
            datasets: [
              {
                label: "Registros por Ubicación",
                data: valores,
                backgroundColor: "rgba(100, 100, 100, 0.4)",
                borderRadius: 4,
                barPercentage: 0.7,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
            scales: {
              x: { title: { display: true, text: "Ubicación" } },
              y: { title: { display: true, text: "Registros" }, beginAtZero: true },
            },
          },
        }
      );
    } catch (e) {
      console.error("Error en gráfica de ubicación:", e);
    }
  }

  window.onload = cargarContenedores;

   // Actualizar gráficas automáticamente cada 60 segundos
  setInterval(() => {
    cargarGraficaContenedor();
    cargarGraficaGeneral();
    cargarGraficaSemana();
    cargarGraficaSemanaContenedor();
    cargarGraficaUbicacion();
  }, 300000); // 60000 milisegundos = 60 segundos




</script>


<script>
  // Colores base
  const GREEN = { r: 40,  g: 167, b: 69 };   // óptimo
  const ORANGE = { r: 253, g: 126, b: 20 };  // advertencia (15 min)
  const RED = { r: 220, g: 53,  b: 69 };     // alto (30+)

  function lerp(a, b, t) {
    return a + (b - a) * t;
  }

  function rgbToCss(c) {
    return `rgb(${Math.round(c.r)}, ${Math.round(c.g)}, ${Math.round(c.b)})`;
  }

  // Dado el promedio en minutos, calcula el color
  function calcularColorEnMinutos(minutos) {
    if (minutos <= 0) return GREEN;
    if (minutos <= 15) {
      const ratio = minutos / 15;
      return {
        r: lerp(GREEN.r, ORANGE.r, ratio),
        g: lerp(GREEN.g, ORANGE.g, ratio),
        b: lerp(GREEN.b, ORANGE.b, ratio)
      };
    } else {
      const over = Math.min(minutos, 30) - 15;
      const ratio = over / 15;
      return {
        r: lerp(ORANGE.r, RED.r, ratio),
        g: lerp(ORANGE.g, RED.g, ratio),
        b: lerp(ORANGE.b, RED.b, ratio)
      };
    }
  }

  // Convierte HH:mm:ss a horas decimales
  function duracionAHoras(horaStr) {
    const [h, m, s] = horaStr.split(":").map(Number);
    return h + m / 60 + s / 3600;
  }

  // Convierte horas decimales a texto HH:mm:ss
  function horasADuracion(horas) {
    const totalSeg = Math.round(horas * 3600);
    const h = Math.floor(totalSeg / 3600);
    const m = Math.floor((totalSeg % 3600) / 60);
    const s = totalSeg % 60;
    const pad = n => String(n).padStart(2, "0");
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  async function actualizarTarjetaVaciado() {
    const tarjeta = document.getElementById("tarjeta-tiempo-vaciado");
    const tiempoText = document.getElementById("tiempo-text");
    const badge = document.getElementById("badge-pequeno");
    const sub = document.getElementById("subtexto");

    try {
      const resp = await fetch(window.settings.apiUrl + 'registro/promedio-tiempollenado', { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      let promedioHoras = data.promedio ? duracionAHoras(data.promedio) : NaN;
      if (isNaN(promedioHoras)) throw new Error("Promedio no es número");

      const duracionStr = horasADuracion(promedioHoras);
      tiempoText.textContent = duracionStr;

      const minutos = promedioHoras * 60;
      const colorObj = calcularColorEnMinutos(minutos);
      tarjeta.querySelector(".card-small").style.backgroundColor = rgbToCss(colorObj);

      if (minutos <= 5) {
        badge.textContent = "Óptimo";
      } else if (minutos <= 15) {
        badge.textContent = "Advertencia";
      } else {
        badge.textContent = "Alto";
      }

      const ahora = new Date();
      sub.textContent = `Última actualización: ${ahora.toLocaleTimeString("es-MX")}`;
    } catch (err) {
      tiempoText.textContent = "--:--:--";
      badge.textContent = "Error";
      sub.textContent = `No se pudo obtener: ${err.message}`;
      tarjeta.querySelector(".card-small").style.backgroundColor = "#ccc";
      console.error("Error tarjeta vaciado:", err);
    }
  }

  actualizarTarjetaVaciado();
  setInterval(actualizarTarjetaVaciado, 20000); // cada 20s
</script>



    </body>
    </html>
