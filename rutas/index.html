<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ecosense - Panel de Rutas</title>
  
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>
  <div class="container">
    <nav class="navbar">
  <p class="eco">Panel de Administrador</p>
  <ul class="opciones">
    <li class="opcion"><a href="../Contenedores/index.html">Contenedores</a></li>
    <li class="opcion"><a href="../Estadisticas/index.html">Estadísticas</a></li>
    <li class="opcion"><a href="../Recolectores/index.html">Recolectores</a></li>
    <li class="opcion"><a href="../rutas/index.html" id="rutas-link">Rutas</a></li>
    <li class="opcion"><a href="../Perfil/index.html" id="perfil-link">Perfil</a></li>
    <img class="picture-user" src="../assets/images/PicUser.png" alt="UserPicture" />
  </ul>
</nav>
<script>
  // Obtener el ID del administrador desde la URL
  const params = new URLSearchParams(window.location.search);
  const adminId = params.get('id');

  // Validación opcional
  if (!adminId || adminId.length !== 24) {
    alert("Sesión no válida o expirada.");
    window.location.href = "../login.html";
  }

  // Enlaces que deben mantener el ID
  document.addEventListener("DOMContentLoaded", () => {
    const linksConservarId = [
      'a[href="../rutas/index.html"]',
      'a[href="../Perfil/index.html"]',
      'a[href="../Main/index.html"]',
      'a[href="../Estadisticas/index.html"]',
      'a[href="../Contenedores/index.html"]',
      'a[href="../Recolectores/index.html"]'
    ];

    linksConservarId.forEach(selector => {
      const link = document.querySelector(selector);
      if (link) {
        const hrefBase = link.getAttribute('href').split('?')[0]; // Eliminar parámetros antiguos
        link.setAttribute('href', `${hrefBase}?id=${adminId}`);
      }
    });
  });
</script>

    <main class="main">
      <div class="container-rutas">
        <div class="left-panel">
          <h2>Rutas registradas</h2>
          <div style="margin:10px 0;">
            <button id="btn-todas" class="btn-filtro active">Todas las rutas</button>
            <button id="btn-mias" class="btn-filtro inactive">Mis rutas</button>
          </div>
          <div id="rutas-container" class="tarjetas-scroll"></div>
        </div>

        <div class="right-panel">
          <button id="crear-ruta" class="btn-ruta crear">Crear ruta</button>
          <button id="modificar-ruta" class="btn-ruta modificar">Modificar ruta</button>
          <button id="eliminar-ruta" class="btn-ruta eliminar">Eliminar ruta</button>
        </div>
      </div>
    </main>

    <div id="modal-modificar" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Modificar Ruta</h3>
          <button class="close-btn" data-close="modificar">&times;</button>
        </div>

        <div class="form-group">
          <label for="select-ruta-modificar">Selecciona ruta</label>
          <select id="select-ruta-modificar">
            <option value="">Cargando...</option>
          </select>
        </div>

        <div id="form-modificar">
          <div class="form-group">
            <label for="input-id">ID (no editable)</label>
            <input type="text" id="input-id" disabled />
          </div>

          <div class="form-group">
            <label for="select-recolector">Recolector</label>
            <select id="select-recolector"></select>
          </div>

          <div class="form-group">
            <label for="select-administrador">Administrador</label>
            <select id="select-administrador"></select>
          </div>

          <div class="form-group">
            <label>Contenedores</label>
            <div id="contenedores-checkboxes">
              <!-- checkboxes generados dinámicamente -->
            </div>
          </div>

          <div class="form-group">
            <label for="input-fecha">Fecha de asignación</label>
            <input type="text" id="input-fecha" disabled />
          </div>

          <div class="form-actions">
            <button id="guardar-modificacion" class="primary-btn save">Asignar ruta</button>
            <button class="secondary-btn" data-close="modificar">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-eliminar" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h3>Eliminar Ruta</h3>
          <button class="close-btn" data-close="eliminar">&times;</button>
        </div>
        <div class="form-group">
          <label for="select-ruta-eliminar">Selecciona ruta a eliminar</label>
          <select id="select-ruta-eliminar">
            <option value="">Cargando...</option>
          </select>
        </div>
        <div id="info-ruta-eliminar" style="margin-top:10px;">
        </div>
        <div class="form-actions">
          <button id="confirmar-eliminacion" class="primary-btn delete">Borrar</button>
          <button class="secondary-btn" data-close="eliminar">Cancelar</button>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-left">
        <div class="social-icons">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-columns">
          <div class="column">
            <h4>Proyecto</h4>
            <p>Visión</p>
            <p>Misión</p>
            <p>Objetivos</p>
          </div>
          <div class="column">
            <h4>Soporte</h4>
            <p>FAQ</p>
            <p>Contacto</p>
            <p>Ayuda</p>
          </div>
          <div class="column">
            <h4>Legal</h4>
            <p>Términos</p>
            <p>Privacidad</p>
            <p>Licencias</p>
          </div>
        </div>
      </div>
    </footer>
  </div>

<script src="/config/config.js"></script>



  <script>


  




    console.log(window.settings.apiUrl);
    const BASE_ENRIQUECIDAS = window.settings.apiUrl+"Rutas/enriquecidas";
    const BASE_SIMPLE = window.settings.apiUrl+"Rutas";
    const ENDPOINT_CONTENEDORES = window.settings.apiUrl+"Contenedor";
    const ENDPOINT_ADMIN = window.settings.apiUrl+"Administrador";
    const ENDPOINT_RECOLECTOR = window.settings.apiUrl+"Recolector";
    const ADMIN_ID_STATIC = adminId;

    const rutasContainer = document.getElementById("rutas-container");
    const btnTodas = document.getElementById("btn-todas");
    const btnMias = document.getElementById("btn-mias");
    let rutasCache = [];
    let contenedoresCache = [];
    let administradoresCache = [];
    let recolectoresCache = [];
    let modo = "todas";

    const modalModificar = document.getElementById("modal-modificar");
    const modalEliminar = document.getElementById("modal-eliminar");

    document.addEventListener("DOMContentLoaded", () => {
      Promise.all([
        fetch(ENDPOINT_CONTENEDORES).then(r => r.ok ? r.json() : []),
        fetch(ENDPOINT_ADMIN).then(r => r.ok ? r.json() : []),
        fetch(ENDPOINT_RECOLECTOR).then(r => r.ok ? r.json() : [])
      ]).then(([contenedores, admins, recolectores]) => {
        contenedoresCache = Array.isArray(contenedores) ? contenedores : [];
        administradoresCache = Array.isArray(admins) ? admins : [];
        recolectoresCache = Array.isArray(recolectores) ? recolectores : [];
        cargarTodasRutas();
        setupFiltros();
        setupBotonesAccion();
        setupModales();
      }).catch(err => {
        console.error("Error cargando catálogos:", err);
        cargarTodasRutas();
        setupFiltros();
        setupBotonesAccion();
        setupModales();
      });
    });

    function setupFiltros() {
      btnTodas.addEventListener("click", () => {
        modo = "todas";
        btnTodas.classList.add("active");
        btnTodas.classList.remove("inactive");
        btnMias.classList.remove("active");
        btnMias.classList.add("inactive");
        cargarTodasRutas();
      });
      btnMias.addEventListener("click", () => {
        modo = "mias";
        btnMias.classList.add("active");
        btnMias.classList.remove("inactive");
        btnTodas.classList.remove("active");
        btnTodas.classList.add("inactive");
        cargarMisRutas(ADMIN_ID_STATIC);
      });
    }

    function setupBotonesAccion() {
      document.getElementById("crear-ruta").addEventListener("click", () => {
        window.location.href = "index2.html";
      });
      document.getElementById("modificar-ruta").addEventListener("click", () => {
        abrirModal("modificar");
      });
      document.getElementById("eliminar-ruta").addEventListener("click", () => {
        abrirModal("eliminar");
      });
    }

    function setupModales() {
      document.querySelectorAll('[data-close="modificar"]').forEach(el => {
        el.addEventListener("click", () => cerrarModal("modificar"));
      });
      document.querySelectorAll('[data-close="eliminar"]').forEach(el => {
        el.addEventListener("click", () => cerrarModal("eliminar"));
      });

      const selectModificar = document.getElementById("select-ruta-modificar");
      selectModificar.addEventListener("change", () => {
        const id = selectModificar.value;
        if (!id) return;
        const ruta = rutasCache.find(r => (r.id === id) || (r.Id === id));
        if (ruta) rellenarFormularioModificar(ruta);
      });

      document.getElementById("guardar-modificacion").addEventListener("click", () => {
        guardarModificacion();
      });

      const selectEliminar = document.getElementById("select-ruta-eliminar");
      selectEliminar.addEventListener("change", () => {
        const id = selectEliminar.value;
        if (!id) return;
        const ruta = rutasCache.find(r => (r.id === id) || (r.Id === id));
        mostrarInfoEliminar(ruta);
      });

      document.getElementById("confirmar-eliminacion").addEventListener("click", () => {
        confirmarEliminar();
      });
    }

    function cargarTodasRutas() {
      rutasContainer.innerHTML = "<p>Cargando rutas enriquecidas...</p>";
      fetch(BASE_ENRIQUECIDAS)
        .then(res => {
          if (!res.ok) throw new Error("Error al obtener rutas enriquecidas");
          return res.json();
        })
        .then(data => {
          rutasCache = Array.isArray(data) ? data : [];
          renderizarRutasEnriquecidas(rutasCache);
          poblarSelectsModificacion(rutasCache);
        })
        .catch(err => {
          console.error(err);
          rutasContainer.innerHTML = "<p style='color:red;'>No se pudieron cargar las rutas.</p>";
        });
    }

    function cargarMisRutas(idAdministrador) {
      rutasContainer.innerHTML = "<p>Cargando tus rutas...</p>";
      fetch(`${BASE_ENRIQUECIDAS}/administrador/${encodeURIComponent(idAdministrador)}`)
        .then(res => {
          if (!res.ok) throw new Error("Error al obtener tus rutas");
          return res.json();
        })
        .then(data => {
          rutasCache = Array.isArray(data) ? data : [];
          renderizarRutasEnriquecidas(rutasCache);
          poblarSelectsModificacion(rutasCache);
        })
        .catch(err => {
          console.error(err);
          rutasContainer.innerHTML = "<p style='color:red;'>No se pudieron cargar tus rutas.</p>";
        });
    }

    function renderizarRutasEnriquecidas(rutas) {
      rutasContainer.innerHTML = "";
      if (!Array.isArray(rutas) || rutas.length === 0) {
        rutasContainer.innerHTML = "<p>No hay rutas para mostrar.</p>";
        return;
      }
      rutas.forEach(ruta => {
        const card = document.createElement("div");
        card.className = "tarjeta";
        const recolectorNombre = ruta.nombreCompletoRecolector || construirNombreDesdeParts(ruta.recolector) || "—";
        const adminNombre = ruta.nombreCompletoAdministrador || construirNombreDesdeParts(ruta.administrador) || "—";
        const fecha = ruta.fechaAsignacion || "";
        const contenedores = ruta.contenedores || [];
        const contenedoresNombres = Array.isArray(contenedores)
          ? contenedores.map(c => c.nombre || c.Nombre || "—").join(", ")
          : "";

        card.innerHTML = `
          <strong>${recolectorNombre} / ${adminNombre}</strong>
          <div>
            <span class="badge">Asignación: ${new Date(fecha).toLocaleString()}</span>
          </div>
          <p><strong>Contenedores:</strong> ${contenedoresNombres}</p>
        `;
        rutasContainer.appendChild(card);
      });
    }

    function poblarSelectsModificacion(rutas) {
      const selectModificar = document.getElementById("select-ruta-modificar");
      const selectEliminar = document.getElementById("select-ruta-eliminar");
      selectModificar.innerHTML = `<option value="">-- selecciona ruta --</option>`;
      selectEliminar.innerHTML = `<option value="">-- selecciona ruta --</option>`;

      rutas.forEach(ruta => {
        const rutaId = ruta.id || ruta.Id || "";
        const recolectorNombre = ruta.nombreCompletoRecolector || construirNombreDesdeParts(ruta.recolector) || "—";
        const adminNombre = ruta.nombreCompletoAdministrador || construirNombreDesdeParts(ruta.administrador) || "—";
        const fecha = ruta.fechaAsignacion ? new Date(ruta.fechaAsignacion).toLocaleDateString() : "—";
        const label = `${recolectorNombre} / ${adminNombre} / ${fecha}`;

        const optMod = document.createElement("option");
        optMod.value = rutaId;
        optMod.textContent = label;
        selectModificar.appendChild(optMod);

        const optDel = document.createElement("option");
        optDel.value = rutaId;
        optDel.textContent = label;
        selectEliminar.appendChild(optDel);
      });

      const selectRecolector = document.getElementById("select-recolector");
      selectRecolector.innerHTML = `<option value="">-- seleccionar recolector --</option>`;
      recolectoresCache.forEach(r => {
        const id = r.id || r._id || "";
        const nombre = construirNombreDesdeParts(r);
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = nombre || id;
        selectRecolector.appendChild(opt);
      });

      const selectAdmin = document.getElementById("select-administrador");
      selectAdmin.innerHTML = `<option value="">-- seleccionar administrador --</option>`;
      administradoresCache.forEach(a => {
        const id = a.id || a._id || "";
        const nombre = construirNombreDesdeParts(a);
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = nombre || id;
        selectAdmin.appendChild(opt);
      });
    }

    function abrirModal(tipo) {
      if (tipo === "modificar") {
        modalModificar.style.display = "flex";
        if (!rutasCache || rutasCache.length === 0) cargarTodasRutas();
      } else if (tipo === "eliminar") {
        modalEliminar.style.display = "flex";
        if (!rutasCache || rutasCache.length === 0) cargarTodasRutas();
      }
    }

    function cerrarModal(tipo) {
      if (tipo === "modificar") modalModificar.style.display = "none";
      if (tipo === "eliminar") modalEliminar.style.display = "none";
    }

    function rellenarFormularioModificar(ruta) {
      const id = ruta.id || ruta.Id || "";
      document.getElementById("input-id").value = id;

      const recolectorId = ruta.idRecolector || ruta.IDRecolector || "";
      const adminId = ruta.idAdministrador || ruta.IDAdministrador || "";
      document.getElementById("select-recolector").value = recolectorId;
      document.getElementById("select-administrador").value = adminId;

      const contenedoresRuta = ruta.contenedores || [];
      const contenedoresContainer = document.getElementById("contenedores-checkboxes");
      contenedoresContainer.innerHTML = "";

      contenedoresCache.forEach(c => {
        const cid = c.id || c._id || c.Id || "";
        const nombre = c.nombre || c.Nombre || "—";
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";
        wrapper.style.gap = "4px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = cid;
        checkbox.id = `cont-${cid}`;
        const esta = (contenedoresRuta || []).some(rc => {
          const rid = rc.id || rc.Id || "";
          return rid === cid;
        });
        if (esta) checkbox.checked = true;

        const label = document.createElement("label");
        label.htmlFor = `cont-${cid}`;
        label.textContent = nombre;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        contenedoresContainer.appendChild(wrapper);
      });

      const fecha = ruta.fechaAsignacion || ruta.FechaAsignacion || "";
      let fechaISO = "";
      try {
        fechaISO = new Date(fecha).toISOString().replace(/\.\d{3}Z$/, "Z");
      } catch {}
      document.getElementById("input-fecha").value = fechaISO ? new Date(fechaISO).toLocaleString() : "";
      document.getElementById("input-fecha").dataset.raw = fechaISO;
    }

    function guardarModificacion() {
      const id = document.getElementById("input-id").value;
      if (!id) {
        alert("Selecciona primero una ruta válida.");
        return;
      }
      const recolector = document.getElementById("select-recolector").value.trim();
      const administrador = document.getElementById("select-administrador").value.trim();
      if (!recolector || !administrador) {
        alert("Recolector y administrador son requeridos.");
        return;
      }

      const contenedoresCheckboxes = document.querySelectorAll("#contenedores-checkboxes input[type=checkbox]");
      const contenedoresSeleccionados = [];
      contenedoresCheckboxes.forEach(cb => {
        if (cb.checked) contenedoresSeleccionados.push(cb.value);
      });

      const fechaAsignacionISO = document.getElementById("input-fecha").dataset.raw || "";
      if (!fechaAsignacionISO) {
        alert("No se pudo obtener la fecha de asignación original.");
        return;
      }

      const payload = {
        Id: id,
        IDRecolector: recolector,
        IDAdministrador: administrador,
        contenedores: contenedoresSeleccionados,
        fechaAsignacion: fechaAsignacionISO
      };

      console.log("Payload a enviar en PUT:", payload);

      fetch(`${BASE_SIMPLE}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(async res => {
          if (!res.ok) {
            const text = await res.text();
            console.error("Respuesta de error del servidor:", text);
            throw new Error("Error al actualizar ruta");
          }
          // si no hay cuerpo (204), no intentar parsear
          const contentType = res.headers.get("Content-Type") || "";
          if (res.status === 204 || !contentType.includes("application/json")) {
            return null;
          }
          return res.json();
        })
        .then(updated => {
          alert("Ruta actualizada correctamente.");
          cerrarModal("modificar");
          if (modo === "todas") cargarTodasRutas();
          else cargarMisRutas(ADMIN_ID_STATIC);
        })
        .catch(err => {
          console.error(err);
          alert("Falló la actualización de la ruta.");
        });
    }

    function mostrarInfoEliminar(ruta) {
      if (!ruta) return;
      const adminNombre = ruta.nombreCompletoAdministrador || construirNombreDesdeParts(ruta.administrador) || "—";
      const recolectorNombre = ruta.nombreCompletoRecolector || construirNombreDesdeParts(ruta.recolector) || "—";
      const fecha = ruta.fechaAsignacion || "";
      const infoDiv = document.getElementById("info-ruta-eliminar");
      infoDiv.innerHTML = `
        <p><strong>Administrador que asignó:</strong> ${adminNombre}</p>
        <p><strong>Recolector actual:</strong> ${recolectorNombre}</p>
        <p><strong>Fecha de asignación:</strong> ${new Date(fecha).toLocaleString()}</p>
      `;
    }

    function confirmarEliminar() {
      const select = document.getElementById("select-ruta-eliminar");
      const id = select.value;
      if (!id) {
        alert("Selecciona una ruta para eliminar.");
        return;
      }
      if (!confirm("¿Estás seguro de eliminar esta ruta? Esta acción es irreversible.")) return;

      fetch(`${BASE_SIMPLE}/${encodeURIComponent(id)}`, {
        method: "DELETE"
      })
        .then(res => {
          if (!res.ok) throw new Error("Error al eliminar ruta");
          alert("Ruta eliminada.");
          cerrarModal("eliminar");
          if (modo === "todas") cargarTodasRutas();
          else cargarMisRutas(ADMIN_ID_STATIC);
        })
        .catch(err => {
          console.error(err);
          alert("No se pudo eliminar la ruta.");
        });
    }

    function construirNombreDesdeParts(obj) {
      if (!obj) return "";
      const nombrePila = obj.nombrePila || obj.NombrePila || "";
      const primerApell = obj.primerApell || obj.PrimerApell || "";
      const segundoApell = obj.segundoApell || obj.SegundoApell || "";
      return `${nombrePila} ${primerApell} ${segundoApell}`.trim();
    }
  </script>
</body>
</html>
